<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>User Profile</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#215bed",
                        "background-light": "#f6f6f8",
                        "background-dark": "#111318",
                        "card-dark": "#1c1f27",
                        "card-glass": "rgba(28, 31, 39, 0.7)",
                        "secondary-text": "#9da5b9"
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "2xl": "2rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #282d39;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3e4556;
        }

        .glass-panel {
            background: rgba(28, 31, 39, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-item {
            position: relative;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #215bed;
            transition: width 0.3s ease;
        }

        .nav-item:hover::after {
            width: 100%;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white min-h-screen flex flex-col overflow-x-hidden selection:bg-primary/30">
    <header
        class="glass-nav fixed top-0 w-full z-50 h-[70px] md:h-[80px] flex items-center justify-between px-4 md:px-8 transition-all duration-300">
        <div class="flex items-center gap-3 cursor-pointer group select-none min-w-fit"
            onclick="window.location.href='homefeed-dashboard.html'">
            <div id="site-logo-img"
                class="w-9 h-9 md:w-10 md:h-10 rounded-xl flex items-center justify-center group-hover:scale-105 transition-all duration-300 bg-cover bg-center bg-no-repeat overflow-hidden">
                <span class="material-symbols-outlined text-[22px] md:text-[26px] text-primary">token</span>
            </div>
            <div class="flex flex-col">
                <span id="site-logo-text"
                    class="text-lg md:text-xl font-bold tracking-tight text-white leading-none"></span>
                <span
                    class="text-[9px] md:text-[10px] font-semibold text-slate-500 uppercase tracking-widest leading-none mt-1 hidden sm:block">User
                    Profile</span>
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-1 lg:gap-2 absolute left-1/2 -translate-x-1/2 z-10">
            <a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group"
                href="homefeed-dashboard.html">
                <span
                    class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">home</span>
                <span class="hidden lg:block font-medium">Home</span>
            </a>
            <a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group"
                href="reels.html">
                <span
                    class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">movie</span>
                <span class="hidden lg:block font-medium">Reels</span>
            </a>
            <a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group relative"
                href="notification.html">
                <div class="relative">
                    <span
                        class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">notifications</span>
                    <span id="notif-badge-desktop"
                        class="hidden absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-bold rounded-full border-2 border-[#0f111a] flex items-center justify-center animate-pulse"></span>
                </div>
                <span class="hidden lg:block font-medium">Notifications</span>
            </a>
            <a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group"
                href="#">
                <span
                    class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">mail</span>
                <span class="hidden lg:block font-medium">Messages</span>
            </a>
        </nav>

        <div class="flex items-center gap-2 md:gap-4 justify-end flex-1 md:flex-initial min-w-0">
            <!-- Search Bar -->
            <div
                class="relative group hidden sm:block w-32 md:w-36 lg:w-48 transition-all focus-within:w-48 md:focus-within:w-52 lg:focus-within:w-64 shrink">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span
                        class="material-symbols-outlined text-slate-500 text-[20px] group-focus-within:text-primary transition-colors">search</span>
                </div>
                <input id="global-search-input"
                    class="bg-white/5 border-transparent focus:bg-white/10 focus:border-primary/50 block w-full pl-10 pr-3 py-2 rounded-full text-xs md:text-sm font-medium focus:outline-none transition-all"
                    placeholder="Search..." type="text">
            </div>

            <button
                class="sm:hidden w-9 h-9 rounded-full hover:bg-white/5 flex items-center justify-center text-slate-300 transition-colors">
                <span class="material-symbols-outlined text-[20px]">search</span>
            </button>
            <div class="w-px h-8 bg-white/10 mx-1 hidden md:block"></div>

            <a href="notification.html" class="md:hidden relative group p-2 text-slate-400">
                <span class="material-symbols-outlined text-[24px]">notifications</span>
                <span id="notif-badge-mobile-header"
                    class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full border border-background-dark animate-pulse"></span>
            </a>

            <!-- Logout button removed -->
            <div class="w-px h-8 bg-white/10 mx-1 hidden md:block"></div>

            <div class="relative group/profile shrink-0">
                <div class="flex items-center gap-3 pl-1 cursor-pointer" onclick="toggleProfileDropdown()">
                    <div class="flex flex-col items-end hidden xl:flex">
                        <span id="header-user-name"
                            class="text-xs font-bold text-white leading-none initials-name">User</span>
                        <div class="flex items-center gap-1">
                            <span id="header-user-handle"
                                class="text-[9px] text-slate-500 font-medium mt-1">@user</span>
                            <span
                                class="material-symbols-outlined text-[14px] text-slate-500 mt-1">keyboard_arrow_down</span>
                        </div>
                    </div>
                    <div class="relative">
                        <img id="header-user-avatar" alt="Avatar"
                            class="w-9 h-9 md:w-10 md:h-10 rounded-full border-2 border-white/10 group-hover/profile:border-primary/50 transition-all object-cover"
                            src="">
                        <div
                            class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-[#0f111a] rounded-full">
                        </div>
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div id="profile-dropdown"
                    class="hidden absolute top-full right-0 mt-3 w-48 bg-card-dark border border-white/10 rounded-xl shadow-2xl overflow-hidden z-50 animate-fade-in">
                    <a href="profile.html"
                        class="block px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">person</span>
                        View Profile
                    </a>
                    <div class="h-px bg-white/5 my-1"></div>
                    <button
                        onclick="localStorage.removeItem('auth_token'); localStorage.removeItem('user_data'); window.location.href='login.html'"
                        class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>
    <main class="flex-1 relative flex justify-center pt-[100px] pb-8 px-4 md:px-0">
        <div
            class="fixed top-[20%] left-[10%] w-[500px] h-[500px] bg-primary/20 rounded-full blur-[120px] pointer-events-none z-0">
        </div>
        <div
            class="fixed bottom-[10%] right-[10%] w-[400px] h-[400px] bg-purple-500/10 rounded-full blur-[100px] pointer-events-none z-0">
        </div>
        <div class="relative w-full max-w-[840px] z-10 flex flex-col gap-6">
            <a href="homefeed-dashboard.html"
                class="hidden md:flex items-center gap-2 text-secondary-text hover:text-white cursor-pointer transition-colors px-2 relative z-50">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                <span class="text-sm font-medium">Back to Feed</span>
            </a>
            <div class="glass-panel rounded-2xl overflow-hidden animate-fade-in shadow-2xl">
                <div class="p-8 pb-0 relative">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
                        <div class="relative group">
                            <div
                                class="size-32 md:size-36 rounded-full border-[6px] border-[#181a20] bg-[#181a20] p-1 relative z-10 shadow-xl">
                                <img id="profile-avatar-display"
                                    class="w-full h-full rounded-full object-cover" src="">
                            </div>
                            <div class="absolute bottom-4 right-2 md:right-4 z-20 bg-green-500 size-5 rounded-full border-4 border-[#181a20]"
                                title="Online"></div>
                        </div>
                        <div class="flex gap-3 mb-2 justify-end" id="profile-actions">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-1">
                            <h1 id="profile-name" class="text-3xl font-bold text-white tracking-tight">Loading...</h1>
                            <span class="material-symbols-outlined text-blue-400 text-[24px]"
                                title="Verified">verified</span>
                        </div>
                        <div id="profile-handle" class="text-secondary-text mb-4 font-medium">@username</div>
                        <p id="profile-bio" class="text-slate-200 text-base leading-relaxed max-w-2xl font-light">
                            Loading...
                        </p>
                        <button id="toggle-info-btn"
                            class="mt-2 text-primary hover:text-blue-400 transition-colors text-sm font-bold flex items-center gap-1 hidden">
                            <span>Show More</span>
                            <span class="material-symbols-outlined text-[18px]">expand_more</span>
                        </button>

                        <div id="extended-profile-info"
                            class="hidden flex flex-col gap-3 mt-4 animate-fade-in bg-white/5 p-4 rounded-xl border border-white/5">
                            <div class="flex flex-wrap gap-x-6 gap-y-3 text-sm text-secondary-text font-medium">
                                <div class="flex items-center gap-2" id="info-location-container">
                                    <span id="profile-location"></span>
                                </div>
                                <div class="flex items-center gap-2" id="info-website-container">
                                    <span id="profile-website"></span>
                                </div>
                                <div class="flex items-center gap-2" id="info-joined-container">
                                    <span id="profile-joined"></span>
                                </div>
                                <div class="flex items-center gap-2 hidden" id="info-email-container">
                                    <span class="material-symbols-outlined text-[18px] text-primary">mail</span>
                                    <span id="profile-email"></span>
                                </div>
                                <div class="flex items-center gap-2 hidden" id="info-phone-container">
                                    <span class="material-symbols-outlined text-[18px] text-primary">call</span>
                                    <span id="profile-phone"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-8 md:gap-12 border-t border-white/5 pt-6 pb-8">
                        <div class="flex flex-col gap-1 cursor-pointer group">
                            <span id="followers-count"
                                class="text-white font-bold text-xl group-hover:text-primary transition-colors">0</span>
                            <span
                                class="text-secondary-text text-xs uppercase tracking-wider font-bold group-hover:text-white transition-colors">Followers</span>
                        </div>
                        <div class="flex flex-col gap-1 cursor-pointer group">
                            <span id="following-count"
                                class="text-white font-bold text-xl group-hover:text-primary transition-colors">0</span>
                            <span
                                class="text-secondary-text text-xs uppercase tracking-wider font-bold group-hover:text-white transition-colors">Following</span>
                        </div>
                        <div class="flex flex-col gap-1 cursor-pointer group">
                            <span id="posts-count"
                                class="text-white font-bold text-xl group-hover:text-primary transition-colors">0</span>
                            <span
                                class="text-secondary-text text-xs uppercase tracking-wider font-bold group-hover:text-white transition-colors">Posts</span>
                        </div>
                    </div>
                </div>
                <div class="px-8 flex gap-8 border-t border-white/5 bg-white/[0.02]">
                    <button class="tab-btn py-4 text-sm font-bold text-primary border-b-2 border-primary relative"
                        data-tab="posts">
                        My Media
                    </button>
                    <button
                        class="tab-btn py-4 text-sm font-medium text-secondary-text hover:text-white transition-colors relative group"
                        data-tab="media">
                        Media
                        <span
                            class="absolute bottom-0 left-0 w-full h-0.5 bg-white/20 scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </button>
                    <button
                        class="tab-btn py-4 text-sm font-medium text-secondary-text hover:text-white transition-colors relative group"
                        data-tab="liked">
                        Liked
                        <span
                            class="absolute bottom-0 left-0 w-full h-0.5 bg-white/20 scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </button>
                    <!-- Saved Reels Tab (Hidden by default, visible only to owner) -->
                    <button
                        id="saved-reels-tab"
                        class="tab-btn py-4 text-sm font-medium text-secondary-text hover:text-white transition-colors relative group hidden"
                        data-tab="saved">
                        Saved
                        <span
                            class="absolute bottom-0 left-0 w-full h-0.5 bg-white/20 scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></span>
                    </button>
                </div>
            </div>
            <div id="user-posts-container" class="space-y-6">
                <div class="flex justify-center py-12">
                    <span class="material-symbols-outlined animate-spin text-primary text-4xl">progress_activity</span>
                </div>
            </div>
            <div class="h-10 text-center text-secondary-text text-sm opacity-50 py-4">End of posts</div>
        </div>
    </main>

    <nav
        class="fixed bottom-0 left-0 z-40 flex w-full items-end justify-between border-t border-slate-200 bg-white px-4 pb-3 pt-2 dark:border-slate-800 dark:bg-background-dark/95 backdrop-blur-lg lg:hidden">
        
        <!-- 1. Home -->
        <a href="homefeed-dashboard.html" class="flex flex-1 flex-col items-center justify-end gap-1 text-slate-500 dark:text-slate-400">
            <span class="material-symbols-outlined text-[26px]">home</span>
            <span class="text-[10px] font-medium">Home</span>
        </a>

        <!-- 2. Reels -->
        <a href="reels.html" class="flex flex-1 flex-col items-center justify-end gap-1 text-slate-500 dark:text-slate-400">
            <span class="material-symbols-outlined text-[26px]">movie</span>
            <span class="text-[10px] font-medium">Reels</span>
        </a>

        <!-- 4. Notifications -->
        <a href="notification.html" class="flex flex-1 flex-col items-center justify-end gap-1 text-slate-500 dark:text-slate-400 relative">
            <div class="relative">
                <span class="material-symbols-outlined text-[26px]">notifications</span>
                <span id="notif-badge-mobile" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-[#0f111a]"></span>
            </div>
            <span class="text-[10px] font-medium">Activity</span>
        </a>

        <!-- 5. Profile (Active) -->
        <a href="profile.html" class="flex flex-1 flex-col items-center justify-end gap-1 text-primary">
            <span class="material-symbols-outlined text-[26px]" style="font-variation-settings: 'FILL' 1;">person</span>
            <span class="text-[10px] font-medium">Profile</span>
        </a>
    </nav>
    <!-- Likers Modal Structure -->
    <div id="likers-modal"
        class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center hidden p-4">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[80vh] border border-white/10 bg-[#1c1f27]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-white text-lg">Likes</h3>
                <button onclick="closeLikersModal()"
                    class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors">
                    <span class="material-symbols-outlined text-slate-400">close</span>
                </button>
            </div>
            <div id="likers-list" class="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                <!-- Content via JS -->
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>

        const token = localStorage.getItem('auth_token');
        const currentUserData = JSON.parse(localStorage.getItem('user_data') || '{}');
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('id') || currentUserData.id;

        if (!token) window.location.href = 'login.html';
    </script>
    <script src="js/post_utils.js"></script>
    <script src="js/notifications.js"></script>
    <script>

        // Initialize state variables early
        let currentTab = 'posts';

        // Global Fetch Interceptor for Token Expiration (401)
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            try {
                const response = await originalFetch(...args);
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    window.location.href = 'login.html';
                }
                return response;
            } catch (error) {
                throw error;
            }
        };



        // Header Init
        if (currentUserData.name) {
            const initialsUrl = DEFAULT_AVATAR(currentUserData.name);
            const avatarUrl = getAvatarUrl(currentUserData) || initialsUrl;

            const headerAvatar = document.getElementById('header-user-avatar');

            const headerName = document.getElementById('header-user-name');
            const headerHandle = document.getElementById('header-user-handle');
            if (headerName) headerName.innerText = currentUserData.name;
            if (headerHandle) headerHandle.innerText = '@' + currentUserData.name.toLowerCase().replace(/\s+/g, '');

            if (headerAvatar) {
                headerAvatar.src = avatarUrl;
                headerAvatar.onerror = function () {
                    this.onerror = null;
                    this.src = initialsUrl;
                };
            }
        }

        if (currentUserData.name) {
            const avatar = `url('https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserData.name)}&background=random')`;
            document.getElementById('header-user-avatar').style.backgroundImage = avatar;
        }



        async function loadProfile() {
            // 1. Load from Cache immediately
            const cacheKey = `profile_${targetUserId}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const parsed = JSON.parse(cached);
                    if (parsed) {
                        window.currentProfileData = parsed;
                        renderProfile(parsed);
                    }
                } catch (e) { console.error("Cache parse error", e); }
            }

            // 2. Fetch Fresh Data
            try {
                const response = await fetch(`${API_BASE_URL}/view`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ id: targetUserId })
                });
                const data = await response.json();

                if (data.success) {
                    window.currentProfileData = data.data; // Store globally for checks
                    localStorage.setItem(cacheKey, JSON.stringify(data.data)); // Update cache
                    renderProfile(data.data);
                    loadTabContent();
                } else {
                    alert('User not found');
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderProfile(user) {
            document.getElementById('profile-name').textContent = user.name;
            document.getElementById('profile-handle').textContent = '@' + user.name.replace(/\s+/g, '').toLowerCase();

            // Bio
            const bio = user.profile?.bio || 'No bio provided.';
            document.getElementById('profile-bio').textContent = bio;

            const isOwner = user.id == currentUserData.id;
            // Check if profile user follows current user (Privacy Logic)
            // user.following is array of users THIS user follows.
            const isFollowedByProfile = user.following && user.following.some(u => u.id == currentUserData.id);
            const canViewDetails = isOwner || isFollowedByProfile;

            const toggleBtn = document.getElementById('toggle-info-btn');
            const infoContainer = document.getElementById('extended-profile-info');

            // Reset
            toggleBtn.classList.add('hidden');
            infoContainer.classList.add('hidden');
            toggleBtn.innerHTML = '<span>Show More</span><span class="material-symbols-outlined text-[18px]">expand_more</span>';

            if (canViewDetails) {
                toggleBtn.classList.remove('hidden');

                // Populate Data
                const locationEl = document.getElementById('profile-location');
                if (user.profile?.address) {
                    locationEl.innerHTML = `<span class="material-symbols-outlined text-[18px] text-primary">location_on</span> ${user.profile.address}`;
                    document.getElementById('info-location-container').classList.remove('hidden');
                } else {
                    document.getElementById('info-location-container').classList.add('hidden');
                }

                const websiteEl = document.getElementById('profile-website');
                if (user.profile?.website) { // Note: Backend doesn't support yet but UI has placeholder
                    websiteEl.innerHTML = `<span class="material-symbols-outlined text-[18px] text-primary">link</span> <a class="hover:underline" href="${user.profile.website}" target="_blank">${user.profile.website}</a>`;
                    document.getElementById('info-website-container').classList.remove('hidden');
                } else {
                    document.getElementById('info-website-container').classList.add('hidden');
                }

                const emailEl = document.getElementById('profile-email');
                if (user.email && (user.show_email == 1 || user.show_email === true)) {
                    emailEl.textContent = user.email;
                    document.getElementById('info-email-container').classList.remove('hidden');
                } else {
                    document.getElementById('info-email-container').classList.add('hidden');
                }

                const phoneEl = document.getElementById('profile-phone');
                if (user.profile?.phone) {
                    phoneEl.textContent = user.profile.phone;
                    document.getElementById('info-phone-container').classList.remove('hidden');
                } else {
                    document.getElementById('info-phone-container').classList.add('hidden');
                }

                const joinedEl = document.getElementById('profile-joined');
                const joinedDate = new Date(user.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                joinedEl.innerHTML = `<span class="material-symbols-outlined text-[18px] text-primary">calendar_month</span> Joined ${joinedDate}`;

                // Toggle Logic
                toggleBtn.onclick = () => {
                    const isHidden = infoContainer.classList.contains('hidden');
                    if (isHidden) {
                        infoContainer.classList.remove('hidden');
                        toggleBtn.innerHTML = '<span>Show Less</span><span class="material-symbols-outlined text-[18px]">expand_less</span>';
                    } else {
                        infoContainer.classList.add('hidden');
                        toggleBtn.innerHTML = '<span>Show More</span><span class="material-symbols-outlined text-[18px]">expand_more</span>';
                    }
                };

            }

            // Counts
            const followersEl = document.getElementById('followers-count');
            const followingEl = document.getElementById('following-count');
            const postsEl = document.getElementById('posts-count');

            followersEl.textContent = user.followers_count || 0;
            followingEl.textContent = user.following_count || 0;
            postsEl.textContent = user.posts_count || 0; // Assuming posts_count is available or calculate it

            // Interaction Handlers
            followersEl.parentElement.onclick = () => openUserListModal('Followers', user.followers || []);
            followingEl.parentElement.onclick = () => openUserListModal('Following', user.following || []);

            postsEl.parentElement.onclick = () => {
                document.getElementById('user-posts-container').scrollIntoView({ behavior: 'smooth' });
            };

            // Avatar handling with fallback
            const initialsUrl = DEFAULT_AVATAR(user.name);
            const avatarUrl = getAvatarUrl(user) || initialsUrl;

            const profileAvatar = document.getElementById('profile-avatar-display');
            if (profileAvatar) {
                profileAvatar.src = avatarUrl;
                profileAvatar.onerror = function () {
                    this.onerror = null;
                    this.src = initialsUrl;
                };
            }

            // Header Avatar Init (Standardize here too)
            if (currentUserData && currentUserData.name) {
                const hInitials = DEFAULT_AVATAR(currentUserData.name);
                const hAvatar = getAvatarUrl(currentUserData) || hInitials;
                const headerAvatar = document.getElementById('header-user-avatar');
                if (headerAvatar) {
                    headerAvatar.src = hAvatar;
                    headerAvatar.onerror = function () {
                        this.onerror = null;
                        this.src = hInitials;
                    };
                }
            }


            // Toggle Saved Tab
            const savedTab = document.getElementById('saved-reels-tab');
            if (isOwner) {
                savedTab.classList.remove('hidden');
            } else {
                savedTab.classList.add('hidden');
            }

            const actionsContainer = document.getElementById('profile-actions');
            actionsContainer.innerHTML = '';
            if (isOwner) {
                const editBtn = document.createElement('button');
                editBtn.className = "px-6 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white font-semibold text-sm hover:bg-white/10 hover:border-white/20 transition-all flex items-center gap-2";
                editBtn.innerHTML = '<span class="material-symbols-outlined text-[20px]">edit</span> Edit Profile';
                editBtn.onclick = () => window.location.href = 'editprofile.html';
                actionsContainer.appendChild(editBtn);
            } else {
                const msgBtn = document.createElement('button');
                msgBtn.className = "px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white font-semibold text-sm hover:bg-white/10 hover:border-white/20 transition-all flex items-center gap-2 shadow-lg shadow-black/20";
                msgBtn.innerHTML = '<span class="material-symbols-outlined text-[20px]">mail</span> Message';
                msgBtn.onclick = () => alert('Messaging coming soon!');
                actionsContainer.appendChild(msgBtn);

                checkFollowStatus(user.id);
            }
        }

        async function loadTabContent() {
            const container = document.getElementById('user-posts-container');
            container.innerHTML = '<div class="flex justify-center py-12"><span class="material-symbols-outlined animate-spin text-primary text-4xl">progress_activity</span></div>';
            container.className = 'space-y-6'; // Default list view

            let body = { user_id: targetUserId };

            try {
                if (currentTab === 'posts') {
                     // Fetch Posts AND Reels for "My Media"
                    const [postsRes, reelsRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/get_posts_by_user?limit=20`, {
                             method: 'POST',
                             headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                             body: JSON.stringify(body)
                        }).then(r => r.json()),
                        fetch(`${API_BASE_URL}/get_reels_by_user`, {
                             method: 'POST',
                             headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                             body: JSON.stringify(body)
                        }).then(r => r.json())
                    ]);

                    let items = [];
                    let totalCount = 0;

                    if (postsRes.success && postsRes.data && postsRes.data.items) {
                        items = [...items, ...postsRes.data.items.map(p => ({...p, type: 'post'}))];
                        totalCount += (postsRes.data.pagination?.total || 0);
                    }
                    if (reelsRes.success && reelsRes.data) {
                        items = [...items, ...reelsRes.data.map(r => ({...r, type: 'reel'}))];
                        totalCount += reelsRes.data.length;
                    }

                    document.getElementById('posts-count').textContent = totalCount;

                    // Merged Sort
                    items.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    if (items.length > 0) {
                        container.innerHTML = items.map(item => {
                            if (item.type === 'reel') return createReelFeedHTML(item); 
                            return createPostHTML(item);
                        }).join('');
                    } else {
                        container.innerHTML = '<p class="text-center text-slate-500 py-8">No media found.</p>';
                    }
                    return;
                }
                
                // --- OLDER TABS LOGIC ---
                let endpoint = '';
                if (currentTab === 'liked') {
                    endpoint = `${API_BASE_URL}/get_liked_posts?limit=20`;
                } else if (currentTab === 'saved') {
                    endpoint = `${API_BASE_URL}/get_saved_reels?limit=20`;
                    container.className = 'grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4'; // Grid
                } else if (currentTab === 'media') {
                    // Filter "Media" from posts manually (Client side only for now, or remove this tab?)
                    // Reusing get_posts for now if tab persists
                    endpoint = `${API_BASE_URL}/get_posts_by_user?limit=20`;
                }

                if (!endpoint) return; // Should not happen

                let method = 'POST';
                if (currentTab === 'saved') method = 'GET';
                
                const fetchOptions = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };
                if (method === 'POST') fetchOptions.body = JSON.stringify(body);
                
                const response = await fetch(endpoint, fetchOptions);
                const data = await response.json();
                container.innerHTML = '';

                if (data.success && data.data && data.data.items && data.data.items.length > 0) {
                     let items = data.data.items;
                     
                     if (currentTab === 'saved') {
                        // REEL GRID
                        container.innerHTML = items.map(reel => {
                            let thumb = '';
                             if (reel.thumbnail_path) {
                                thumb = reel.thumbnail_path.startsWith('http') ? reel.thumbnail_path : `${PUBLIC_URL}/${reel.thumbnail_path}`;
                            }
                            return `
                                <div class="aspect-[9/16] bg-black/50 rounded-xl overflow-hidden relative group cursor-pointer border border-white/5" onclick="window.location.href='reels.html?id=${reel.id}'">
                                    ${thumb ? `<img src="${thumb}" class="w-full h-full object-cover transition-transform group-hover:scale-105">` : '<div class="flex items-center justify-center h-full text-slate-500"><span class="material-symbols-outlined">movie</span></div>'}
                                    <div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition-colors"></div>
                                    <div class="absolute bottom-2 left-2 flex items-center gap-1 text-white text-xs font-bold drop-shadow-md">
                                        <span class="material-symbols-outlined text-[14px]">play_arrow</span>
                                        <span>${reel.views_count || 0}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                     } else {
                        // POSTS (Liked or Media)
                        if (currentTab === 'media') {
                            items = items.filter(post => post.attachments && post.attachments.length > 0);
                            if (items.length === 0) {
                                 container.innerHTML = '<p class="text-center text-slate-500 py-8">No media found.</p>';
                                 return;
                            }
                        }
                        container.innerHTML = items.map(post => createPostHTML(post)).join('');
                     }
                } else {
                     container.innerHTML = '<p class="text-center text-slate-500 py-8">No items found.</p>';
                }

            } catch (e) { console.error(e); }
        }

        function createReelFeedHTML(reel) {
            const user = reel.user || {};
            const avatar = getAvatarUrl(user) || DEFAULT_AVATAR(user.name);
            const time = new Date(reel.created_at).toLocaleDateString();
            
            // Construct video URL (Add storage prefix for local files)
            let videoUrl = reel.video_path;
            if (videoUrl && !videoUrl.startsWith('http')) {
                const clean = videoUrl.startsWith('/') ? videoUrl.substring(1) : videoUrl;
                videoUrl = `${PUBLIC_URL}/storage/${clean}`;
            }

            let thumbUrl = reel.thumbnail_path;
            if (thumbUrl && !thumbUrl.startsWith('http')) {
                 const clean = thumbUrl.startsWith('/') ? thumbUrl.substring(1) : thumbUrl;
                 thumbUrl = `${PUBLIC_URL}/storage/${clean}`;
            }
            
            return `
            <article class="bg-white dark:bg-[#1e2330] rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden w-full max-w-xl mx-auto">
                <div class="p-4 flex items-center justify-between">
                     <div class="flex items-center gap-3">
                        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover border border-slate-200 dark:border-slate-700" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                        <div>
                             <h3 class="font-bold text-slate-900 dark:text-white text-sm">${user.name || 'Unknown User'}</h3>
                             <p class="text-xs text-slate-500">${time} â€¢ <span class="material-symbols-outlined text-[10px] align-middle">movie</span> Reel</p>
                        </div>
                     </div>
                </div>
                <div class="relative bg-black aspect-[9/16] max-h-[500px] flex items-center justify-center cursor-pointer group" onclick="window.location.href='reels.html?id=${reel.id}'">
                     <!-- Just a thumbnail preview for profile feed, link to reels player -->
                     ${thumbUrl ? `<img src="${thumbUrl}" class="h-full w-full object-contain filter brightness-75 group-hover:brightness-100 transition-all">` : '<div class="h-full w-full flex items-center justify-center"><span class="material-symbols-outlined text-white text-4xl">movie</span></div>'}
                     <div class="absolute inset-0 flex items-center justify-center">
                         <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-white text-3xl">play_arrow</span>
                         </div>
                     </div>
                </div>
                <div class="p-4">
                     <p class="text-slate-900 dark:text-white text-sm mb-2">${reel.caption || ''}</p>
                     <div class="flex items-center gap-4 text-slate-500">
                          <div class="flex items-center gap-1">
                              <span class="material-symbols-outlined text-[20px]">favorite</span>
                              <span class="text-xs">${reel.reactions_count || 0}</span>
                          </div>
                          <div class="flex items-center gap-1">
                              <span class="material-symbols-outlined text-[20px]">chat_bubble</span>
                              <span class="text-xs">${reel.comments_count || 0}</span>
                          </div>
                          <div class="flex items-center gap-1 ml-auto">
                               <span class="material-symbols-outlined text-[20px]">visibility</span>
                               <span class="text-xs">${reel.views || 0}</span>
                          </div>
                     </div>
                </div>
            </article>
            `;
        }


        async function checkFollowStatus(targetId) {
            // Status is now provided directly in the profile response as connection_status
            // We can just rely on the global 'profileData' object if it's available, 
            // but 'checkFollowStatus' is called after fetchProfile.

            // However, fetchProfile renders the profile initially. 
            // Let's ensure we use the data from the 'fetchProfile' response which is usually stored or passed.

            // Wait, fetchProfile updates the DOM directly. It doesn't seem to store 'profileData' globally 
            // other than potentially 'userData' which is the logged in user.
            // But we need the connection status relative to the VIEWED user.

            // Let's verify where 'profileData' or the response is handled.
            // It seems 'fetchProfile' calls 'checkFollowStatus' at the end? 
            // No, let's look at how it was called.
            // If we can't find where it's called, we can just fetch the status or rely on the fact that
            // we should have passed this info to renderFollowButton directly from fetchProfile.

            // Assuming fetchProfile is refactored to call this, OR we can just fetch the profile again? No redundant calls.

            // BETTER: Update 'fetchProfile' to read connection_status from response and call renderFollowButton.
            // And empty this function or make it just a wrapper if needed.
            // But to be safe and clean, let's replace this complex logic with a manual check only if needed,
            // Otherwise we trust fetchProfile to handle it.

            // Actually, `fetchProfile` is not shown here. I should check how it's implemented.
            // But for now, I will modify this function to assume `window.currentProfileData` is available
            // OR, even better: I'll modify `fetchProfile` (which I can't see but I can guess is in this file)
            // to set a global variable.

            if (window.currentProfileData && window.currentProfileData.connection_status) {
                renderFollowButton(targetId, window.currentProfileData.connection_status);
            } else {
                // Fallback if not available (shouldn't happen with my backend fix)
                renderFollowButton(targetId, 'none');
            }
        }

        function renderFollowButton(targetId, status) {
            const container = document.getElementById('profile-actions');
            const existingBtn = document.getElementById('follow-btn');
            if (existingBtn) existingBtn.remove();

            const btn = document.createElement('button');
            btn.id = 'follow-btn';

            if (status === 'accepted') {
                // Already Friends/Following
                btn.className = "px-6 py-2.5 rounded-xl bg-white/10 text-white font-bold text-sm hover:bg-red-500/20 hover:text-red-400 transition-all border border-white/20 flex items-center gap-2";
                btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">person_remove</span> Unfollow';
                btn.onclick = () => toggleFollow(targetId, 'unfollow');
            }
            else if (status === 'pending') {
                // Request Sent
                btn.className = "px-6 py-2.5 rounded-xl bg-white/10 text-secondary-text font-bold text-sm hover:bg-white/20 hover:text-white transition-all border border-white/20 flex items-center gap-2";
                btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">pending</span> Requested';
                // Clicking again cancels the request
                btn.onclick = () => toggleFollow(targetId, 'unfollow');
            }
            else {
                // Not Following
                btn.className = "px-6 py-2.5 rounded-xl bg-primary text-white font-bold text-sm hover:bg-blue-600 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2 transform hover:-translate-y-0.5";
                btn.innerHTML = '<span class="material-symbols-outlined text-[20px]">person_add</span> Follow';
                btn.onclick = () => toggleFollow(targetId, 'follow');
            }
            container.appendChild(btn);
        }

        async function toggleFollow(targetId, action) {
            // --- OPTIMISTIC UI ---
            // Store previous state to revert if needed
            // We can infer previous state from action:
            // if action is 'follow', previous was 'none'
            // if action is 'unfollow', previous was 'pending' or 'accepted'.
            // For simplicity, we just move forward. If it fails, we reload profile or handle messy revert.

            // Optimistically Update Button
            if (action === 'follow') {
                renderFollowButton(targetId, 'pending');
            } else {
                renderFollowButton(targetId, 'none');
            }

            try {
                // If action is 'unfollow', it works for both 'accepted' (Unfollow) and 'pending' (Cancel Request) 
                // because backend 'unfollowUser' just detaches the relation.
                const endpoint = action === 'follow' ? 'follow' : 'unfollow';

                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ user_id: targetId })
                });
                const data = await response.json();
                if (data.success) {
                    // Check if we need to correct the 'pending' vs 'accepted' assumption
                    if (action === 'follow') {
                        const status = data.data && data.data.status ? data.data.status : 'pending';
                        if (status === 'accepted') {
                            renderFollowButton(targetId, 'accepted');
                        }
                    }

                    // Invalidate Caches
                    localStorage.removeItem('profile_' + targetId);
                    localStorage.removeItem('dashboard_suggestions_cache');
                    localStorage.removeItem('dashboard_requests_cache');
                } else {
                    // Revert on failure (basic revert)
                    if (action === 'follow') renderFollowButton(targetId, 'none');
                    else renderFollowButton(targetId, 'pending'); // or accepted, tricky to know without more state. 
                    // Best effort:
                    showToast(data.message || 'Action failed', 'error');
                }
            } catch (e) {
                console.error(e);
                // Revert
                if (action === 'follow') renderFollowButton(targetId, 'none');
            }
        }

        // Tab Interface
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Reset Layout
                tabBtns.forEach(b => {
                    b.classList.remove('text-primary', 'border-b-2', 'border-primary', 'font-bold');
                    b.classList.add('text-secondary-text', 'font-medium');
                    const indicator = b.querySelector('span');
                    if (indicator) indicator.classList.remove('scale-100');
                });

                // Activate Clicked
                btn.classList.remove('text-secondary-text', 'font-medium');
                btn.classList.add('text-primary', 'border-b-2', 'border-primary', 'font-bold');

                // Set Tab
                currentTab = btn.dataset.tab;
                loadTabContent();
            });
        });



    </script>
    <script>
        loadProfile();
        setupGlobalSearch();
    </script>


    <script src="js/site_branding.js"></script>
</body>

</html>