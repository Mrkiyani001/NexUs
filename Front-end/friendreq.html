<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Friends - NexUs</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3b82f6", 
                        "primary-hover": "#2563eb",
                        "accent-purple": "#8b5cf6",
                        "accent-pink": "#ec4899",
                        "background-dark": "#0f111a",
                        "surface-dark": "#161b27",
                        "glass-border": "rgba(255, 255, 255, 0.08)",
                        "glass-border-light": "rgba(255, 255, 255, 0.12)",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "2xl": "1.5rem", "3xl": "2rem", "full": "9999px"},
                    animation: {
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'like-bounce': 'likeBounce 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        likeBounce: {
                            '0%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.3)' },
                            '100%': { transform: 'scale(1)' },
                        }
                    }
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f111a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #2a303c; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3b4254; 
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(28, 32, 45, 0.6) 0%, rgba(20, 24, 34, 0.8) 100%);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        .glass-nav {
            background: rgba(15, 17, 26, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        .glass-nav-mobile {
            background: rgba(15, 17, 26, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        .input-glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
        }.text-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .text-gradient-primary {
            background: linear-gradient(135deg, #60a5fa 0%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }.btn-icon-hover {
            position: relative;
            overflow: hidden;
        }
        .btn-icon-hover::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: currentColor;
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        .btn-icon-hover:hover::after {
            width: 150%;
            height: 150%;
        }
        .action-btn {
            @apply flex items-center gap-2 px-3 py-2 rounded-full transition-all duration-300 text-slate-400 font-medium text-sm;
        }
        .action-btn:hover {
            @apply bg-white/5 text-slate-200;
        }
        .action-btn.active {
            @apply text-red-500 bg-red-500/10;
        }
        .action-btn i {
            @apply transition-transform duration-300;
        }
        .action-btn:hover i {
            @apply scale-110;
        }.img-zoom-container {
            overflow: hidden;
        }
        .img-zoom {
            transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .img-zoom-container:hover .img-zoom {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="font-display bg-background-dark text-slate-200 min-h-screen relative overflow-x-hidden antialiased selection:bg-primary/30 selection:text-white flex flex-col">
<div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
<div class="absolute top-[-10%] left-[10%] w-[50vw] h-[50vw] bg-primary/10 rounded-full blur-[120px] animate-blob mix-blend-screen opacity-40"></div>
<div class="absolute top-[10%] right-[-10%] w-[40vw] h-[40vw] bg-accent-purple/10 rounded-full blur-[130px] animate-blob animation-delay-2000 mix-blend-screen opacity-40"></div>
<div class="absolute bottom-[-20%] left-[30%] w-[45vw] h-[45vw] bg-accent-pink/5 rounded-full blur-[100px] animate-blob animation-delay-4000 mix-blend-screen opacity-30"></div>
</div>
<header class="glass-nav fixed top-0 w-full z-50 flex flex-wrap md:flex-nowrap items-center justify-between px-4 md:px-8 py-3 md:py-0 min-h-[70px] md:h-[80px] transition-all duration-300">
<div class="flex items-center gap-2.5 cursor-pointer group select-none min-w-fit order-1 mr-4 md:mr-0">
<div class="relative w-9 h-9 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-primary to-accent-purple flex items-center justify-center text-white shadow-lg shadow-primary/20 group-hover:shadow-primary/40 group-hover:scale-105 transition-all duration-300 overflow-hidden">
<span class="material-symbols-outlined text-[22px] md:text-[26px] relative z-10">token</span>
<div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
</div>
<span class="text-xl md:text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-blue-100 to-slate-400 group-hover:to-white transition-all duration-300 font-display">NexUs</span>
</div>
<nav class="hidden md:flex items-center gap-1 lg:gap-2 absolute left-1/2 -translate-x-1/2 z-10">
<a class="relative flex items-center gap-2 px-4 lg:px-6 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group" href="homefeed-dashboard.html">
<span class="material-symbols-outlined text-[24px]">home</span>
<span class="hidden lg:inline">Home</span>
</a>
<a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full bg-gradient-to-r from-primary/10 to-blue-600/10 border border-primary/20 text-primary font-semibold transition-all group shadow-[0_0_15px_rgba(59,130,246,0.15)]" href="#">
<span class="material-symbols-outlined text-[24px]" style="font-variation-settings: 'FILL' 1;">group</span>
<span class="hidden lg:block font-medium">Friends</span>
</a>
<a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group relative" href="notification.html">
<div class="relative">
<span class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">notifications</span>
<span class="hidden absolute top-0.5 right-0.5 w-2 h-2 bg-accent-pink rounded-full ring-2 ring-[#0f111a] animate-pulse"></span>
</div>
<span class="hidden lg:block font-medium">Notifications</span>
</a>
<a class="flex items-center gap-2 px-3 lg:px-4 py-2.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all group" href="message.html">
<span class="material-symbols-outlined text-[24px] group-hover:scale-110 transition-transform">mail</span>
<span class="hidden lg:block font-medium">Messages</span>
</a>
</nav>
<div class="flex items-center gap-2 md:gap-4 justify-end flex-1 md:flex-none order-2 md:order-3 min-w-0">
            <!-- Search Bar -->
            <div class="relative group hidden sm:block w-32 md:w-36 lg:w-48 transition-all focus-within:w-48 md:focus-within:w-52 lg:focus-within:w-64 shrink">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="material-symbols-outlined text-slate-500 text-[20px] group-focus-within:text-primary transition-colors">search</span>
                </div>
                <input id="global-search-input"
                    class="bg-white/5 border-transparent focus:bg-white/10 focus:border-primary/50 block w-full pl-10 pr-3 py-2 rounded-full text-xs md:text-sm font-medium focus:outline-none transition-all"
                    placeholder="Search..." type="text">
            </div>

            <button class="sm:hidden w-9 h-9 rounded-full hover:bg-white/5 flex items-center justify-center text-slate-300">
                <span class="material-symbols-outlined text-[20px]">search</span>
            </button>
            <div class="w-px h-8 bg-white/10 mx-1 hidden md:block"></div>
            
             <a href="notification.html" class="md:hidden relative group p-2 text-slate-400">
                <span class="material-symbols-outlined text-[24px]">notifications</span>
                <span id="notif-badge-mobile-header" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full border border-background-dark animate-pulse"></span>
            </a>

            <!-- Profile Dropdown -->
            <div class="relative group/profile shrink-0">
                <div class="flex items-center gap-3 pl-1 cursor-pointer" onclick="toggleProfileDropdown()">
                    <div class="flex flex-col items-end hidden xl:flex">
                        <span id="header-user-name" class="text-xs font-bold text-white leading-none initials-name">User</span>
                        <div class="flex items-center gap-1">
                            <span id="header-user-handle" class="text-[9px] text-slate-500 font-medium mt-1">@user</span>
                            <span class="material-symbols-outlined text-[14px] text-slate-500 mt-1">keyboard_arrow_down</span>
                        </div>
                    </div>
                    <div class="relative">
                        <img id="header-user-avatar" alt="Avatar"
                            class="w-9 h-9 md:w-10 md:h-10 rounded-full border-2 border-white/10 group-hover/profile:border-primary/50 transition-all object-cover" src="">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-[#0f111a] rounded-full"></div>
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div id="profile-dropdown" class="hidden absolute top-full right-0 mt-3 w-48 bg-card-dark border border-white/10 rounded-xl shadow-2xl overflow-hidden z-50 animate-fade-in">
                    <a href="profile.html" class="block px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">person</span>
                        View Profile
                    </a>
                    <div class="h-px bg-white/5 my-1"></div>
                    <a href="setting-user.html"
                        class="block px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">settings</span>
                        Settings
                    </a>
                    <div class="h-px bg-white/5 my-1"></div>
                    <button onclick="localStorage.removeItem('auth_token'); localStorage.removeItem('user_data'); window.location.href='login.html'" 
                        class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Logout
                    </button>
                </div>
            </div>
</div>
</header>
</header>
<main class="pt-[140px] md:pt-[110px] pb-20 px-4 md:px-8 w-full max-w-[1400px] mx-auto flex flex-col gap-10">
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl md:text-4xl font-black text-white tracking-tight">Friends</h1>
            <p class="text-slate-400 mt-2 font-medium">Manage requests and find new connections.</p>
        </div>
        <!-- Removed "In/Out" Filter Buttons as requested -->
    </div>



    <!-- Tabs Navigation -->
    <section class="mb-8">
        <div class="flex items-center justify-between mb-6">
             <!-- Tabs -->
             <!-- Tabs -->
             <div class="flex space-x-2 bg-white/5 p-1 rounded-xl backdrop-blur-md border border-white/5 overflow-x-auto">
                <button onclick="switchTab('requests')" id="tab-requests" class="whitespace-nowrap px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 text-white bg-primary shadow-lg shadow-primary/25 relative">
                    Requests <span id="requests-badge-tab" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#0f111a]"></span>
                </button>
                <button onclick="switchTab('whotofollow')" id="tab-whotofollow" class="whitespace-nowrap px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 text-slate-400 hover:text-white hover:bg-white/5">
                    Who to Follow
                </button>
                <button onclick="switchTab('suggestions')" id="tab-suggestions" class="whitespace-nowrap px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 text-slate-400 hover:text-white hover:bg-white/5">
                    Suggestions
                </button>
                <button onclick="switchTab('friends')" id="tab-friends" class="whitespace-nowrap px-6 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 text-slate-400 hover:text-white hover:bg-white/5">
                    Your Friends
                </button>
             </div>

             <!-- Refresh Button -->
             <button onclick="refreshCurrentTab()" class="p-2 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all outline-none focus:outline-none" title="Refresh">
                <span id="refresh-icon" class="material-symbols-outlined transition-transform duration-700">refresh</span>
             </button>
        </div>

        <!-- Dynamic Content Container -->
        <div id="content-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
             <!-- Content Injected Here -->
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-controls" class="w-full flex justify-center items-center gap-4 mt-8 py-4"></div>
    </section>

    <!-- Old Suggestions Section (Removed/Replaced by above) -->
    <!-- <section> ... </section> -->
             <!-- Dynamic Content -->
             <div class="col-span-full text-center py-8 text-slate-500 text-sm">Loading suggestions...</div>
        </div>
    </section>
</main>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
    // const token = localStorage.getItem('auth_token');
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    window.currentUserData = userData;

    // if (!token) window.location.href = 'login.html';
</script>
<script src="js/post_utils.js"></script>
<script src="js/notifications.js"></script>
<script src="js/site_branding.js"></script>
<script>
    // Header Init
    document.addEventListener('DOMContentLoaded', () => {
         if (userData.name) {
            const initialsUrl = window.DEFAULT_AVATAR(userData.name);
            const avatarUrl = getAvatarUrl(userData) || initialsUrl;
            
            // Header Avatar
            const headerAvatar = document.getElementById('header-user-avatar');
            if(headerAvatar) {
                headerAvatar.src = avatarUrl;
                headerAvatar.onerror = function() { this.src = initialsUrl; };
            }
            // Mobile Nav Avatar
            const navAvatar = document.getElementById('mobile-nav-avatar');
             if(navAvatar) navAvatar.src = avatarUrl;


            // Header Name & Handle
            const headerUserName = document.getElementById('header-user-name');
            const headerUserHandle = document.getElementById('header-user-handle');
            if(headerUserName) headerUserName.textContent = userData.name;
            if(headerUserHandle) headerUserHandle.textContent = '@' + userData.name.toLowerCase().replace(/\s+/g, '');
         }
         
         loadRequests();
         // Recursive Polling
         async function startRequestPolling() {
             await loadRequests(true);
             setTimeout(startRequestPolling, 3000);
         }
         startRequestPolling();
    });

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profile-dropdown');
        if(dropdown) {
            dropdown.classList.toggle('hidden');
        }
    }

    // Close dropdown on click outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('profile-dropdown');
        const profileGroup = document.querySelector('.group\\/profile'); // Target the profile container
        if(dropdown && !dropdown.classList.contains('hidden')) {
             if(profileGroup && !profileGroup.contains(e.target) && !dropdown.contains(e.target)) {
                 dropdown.classList.add('hidden');
             }
        }
    });

    let isFetching = false;
    async function loadRequests(isAutoRefresh = false) {
        if(isFetching) return;
        isFetching = true;

        try {
            const response = await fetch(`${API_BASE_URL}/fetch_requests`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            // Handle robust data parsing (support old or new format)
            const items = data.data && data.data.items ? data.data.items : (Array.isArray(data.data) ? data.data : []);
            
            // Update Badges
            updateBadges(items.length);

        } catch (e) { console.error("Error loading requests count", e); }
        finally { isFetching = false; }
    }

    function updateBadges(count) {
        // Main Header Badge (if exists)
        const headerBadge = document.getElementById('request-count'); 
        // Mobile Badge
        const mobileBadge = document.getElementById('mobile-nav-requests-badge'); 
        const mobileHeaderBadge = document.getElementById('notif-badge-mobile-header');
        // Tab Badge
        const tabBadge = document.getElementById('requests-badge-tab');
        
        // Show/Hide logic
        if(count > 0) {
            if(headerBadge) { headerBadge.innerText = count; headerBadge.classList.remove('hidden'); }
            if(mobileBadge) mobileBadge.classList.remove('hidden');
            if(mobileHeaderBadge) mobileHeaderBadge.classList.remove('hidden');
            if(tabBadge) tabBadge.classList.remove('hidden');
        } else {
            if(headerBadge) headerBadge.classList.add('hidden');
            if(mobileBadge) mobileBadge.classList.add('hidden');
            if(mobileHeaderBadge) mobileHeaderBadge.classList.add('hidden');
            if(tabBadge) tabBadge.classList.add('hidden');
        }
    }

    async function handleRequest(userId, action, btn) {
        // Optimistic UI: Remove card immediately
        const card = btn.closest('.glass-card');
        card.style.opacity = '0';
        setTimeout(() => {
            card.remove(); 
            // If empty, reload to show empty state
             if(document.querySelectorAll('#content-container .glass-card').length === 0) {
                 if(currentTab === 'requests') fetchRequests(pageStates.requests);
             }
        }, 300);

        const endpoint = action === 'accept' ? 'accept_request' : 'reject_request';
        
        try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            const data = await response.json();
            if(data.success) {
                showToast(data.message, 'success');
                // Invalidate Caches
                localStorage.removeItem('requests_cache');
                localStorage.removeItem('dashboard_requests_cache');
                localStorage.removeItem('profile_' + userId);
                
                // Refresh to update counts
                setTimeout(() => {
                    loadRequests(); // Updates Badge
                    if(currentTab === 'requests') fetchRequests(pageStates.requests); // Updates List
                }, 500); 
            } else {
                showToast(data.message || 'Action failed', 'error');
                if(currentTab === 'requests') fetchRequests(pageStates.requests); // Revert
            }
        } catch(e) {
            console.error(e);
            if(currentTab === 'requests') fetchRequests(pageStates.requests);
        }
    }

    async function unfollowUser(btn, userId) {
        if(!confirm("Are you sure you want to unfollow this user?")) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined text-[18px] animate-spin">progress_activity</span>';
        
        try {
            const response = await fetch(`${API_BASE_URL}/unfollow`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }) // Ensure API accepts 'user_id' or 'id'
            });
            const data = await response.json();
            if(data.success) {
                showToast("Unfollowed successfully", 'success');
                // Remove card from UI
                const card = btn.closest('.glass-card');
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove(); 
                    if(document.querySelectorAll('#content-container .glass-card').length === 0) {
                        fetchFriends(pageStates.friends);
                    }
                }, 300);
            } else {
                showToast(data.message || "Failed to unfollow", 'error');
                btn.disabled = false;
                btn.innerHTML = `<span class="material-symbols-outlined text-[18px]">person_remove</span> Unfollow`;
            }
        } catch(e) {
            console.error(e);
            showToast("Error processing request", 'error');
            btn.disabled = false;
            btn.innerHTML = `<span class="material-symbols-outlined text-[18px]">person_remove</span> Unfollow`;
        }
    }

    // --- TAB LOGIC ---
    let currentTab = 'requests'; 
    let pageStates = {
        requests: 1,
        whotofollow: 1,
        suggestions: 1,
        friends: 1
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadRequests(); // Existing badge logic
        
        // Check URL Params for Tab
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        const validTabs = ['requests', 'whotofollow', 'suggestions', 'friends'];
        
        if (tab && validTabs.includes(tab)) {
            switchTab(tab);
        } else {
            switchTab('requests'); // Default
        }
    });

    function switchTab(tab) {
        currentTab = tab;
        
        // Update UI
        ['requests', 'whotofollow', 'suggestions', 'friends'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            if(t === tab) {
                btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                btn.classList.add('text-white', 'bg-primary', 'shadow-lg', 'shadow-primary/25');
            } else {
                btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                btn.classList.remove('text-white', 'bg-primary', 'shadow-lg', 'shadow-primary/25');
            }
        });

        // Fetch Data for Tab
        if (tab === 'suggestions') fetchSuggestions(pageStates.suggestions);
        else if (tab === 'friends') fetchFriends(pageStates.friends);
        else if (tab === 'requests') fetchRequests(pageStates.requests);
        else if (tab === 'whotofollow') fetchWhoToFollow(pageStates.whotofollow);
    }

    function refreshCurrentTab() {
        // Reset page to 1 for refresh
        const page = 1; 
        if (currentTab === 'suggestions') { pageStates.suggestions = 1; fetchSuggestions(1); }
        else if (currentTab === 'friends') { pageStates.friends = 1; fetchFriends(1); }
        else if (currentTab === 'requests') { pageStates.requests = 1; fetchRequests(1); }
        else if (currentTab === 'whotofollow') { pageStates.whotofollow = 1; fetchWhoToFollow(1); }
    }

    // --- FETCH FUNCTIONS ---
    async function fetchSuggestions(page = 1) {
        pageStates.suggestions = page;
        renderLoading();
        try {
            const response = await fetch(`${API_BASE_URL}/fetch_suggestions?page=${page}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 10 }) 
            });
            const data = await response.json();
            handleTabResponse(data, 'suggestions');
        } catch (e) { handleError(e); }
    }

    async function fetchFriends(page = 1) {
        pageStates.friends = page;
        renderLoading();
        try {
            const response = await fetch(`${API_BASE_URL}/fetch_following?page=${page}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 10 }) 
            });
            const data = await response.json();
            handleTabResponse(data, 'friends');
        } catch (e) { handleError(e); }
    }

    async function fetchRequests(page = 1) {
        pageStates.requests = page;
        renderLoading();
        try {
            const response = await fetch(`${API_BASE_URL}/fetch_requests?page=${page}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 10 }) 
            });
            const data = await response.json();
            handleTabResponse(data, 'requests');
        } catch (e) { handleError(e); }
    }

    async function fetchWhoToFollow(page = 1) {
        pageStates.whotofollow = page;
        renderLoading();
        try {
            const response = await fetch(`${API_BASE_URL}/fetch_who_to_follow?page=${page}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limit: 10 }) 
            });
            const data = await response.json();
            handleTabResponse(data, 'whotofollow');
        } catch (e) { handleError(e); }
    }


    // --- HELPERS ---
    function renderLoading() {
        const container = document.getElementById('content-container');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="inline-block w-8 h-8 border-4 border-white/20 border-t-primary rounded-full animate-spin"></div></div>';
        document.getElementById('pagination-controls').innerHTML = '';
    }

    function handleError(e) {
        console.error(e);
        const container = document.getElementById('content-container');
        container.innerHTML = '<div class="col-span-full text-center py-8 text-red-500 text-sm">Error loading content.</div>';
    }

    function handleTabResponse(data, type) {
        const container = document.getElementById('content-container');
        // Support both old array structure (if any) and new pagination structure
        const items = data.data && data.data.items ? data.data.items : (Array.isArray(data.data) ? data.data : []);
        const metadata = data.data && data.data.pagination ? data.data.pagination : null;

        if (data.success && items.length > 0) {
            container.innerHTML = '';
            items.forEach(user => {
                const html = renderUserCard(user, type);
                container.insertAdjacentHTML('beforeend', html);
            });
            renderPagination(metadata, type);
        } else {
            let emptyMsg = "";
            if (type === 'suggestions') emptyMsg = "No suggestions found.";
            else if (type === 'friends') emptyMsg = "You haven't followed anyone yet.";
            else if (type === 'requests') emptyMsg = "No pending requests.";
            else if (type === 'whotofollow') emptyMsg = "No one waiting for you to follow back.";

            container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-500 text-sm flex flex-col items-center gap-2"><span class="material-symbols-outlined text-4xl opacity-20">group_off</span>${emptyMsg}</div>`;
            document.getElementById('pagination-controls').innerHTML = '';
        }
    }

    function renderUserCard(user, type) {
        const avatar = getAvatarUrl(user) || window.DEFAULT_AVATAR(user.name);
        // Different Actions based on Type
        let actionBtn = '';
        
        if (type === 'suggestions') {
            actionBtn = `
                <button onclick="followUser(this, ${user.id})" class="w-full py-2.5 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 font-semibold border border-emerald-500/20 hover:border-emerald-500/40 transition-all flex items-center justify-center gap-2 text-sm group/btn">
                    <span class="material-symbols-outlined text-[18px] group-hover/btn:scale-110 transition-transform">person_add</span>
                    Add Friend
                </button>`;
        } else if (type === 'friends') {
            actionBtn = `
                <button onclick="unfollowUser(this, ${user.id})" class="w-full py-2.5 rounded-xl bg-white/5 hover:bg-red-500/10 text-slate-400 hover:text-red-400 font-semibold border border-white/10 hover:border-red-500/20 transition-all flex items-center justify-center gap-2 text-sm group/btn">
                    <span class="material-symbols-outlined text-[18px]">person_remove</span>
                    Unfollow
                </button>`;
        } else if (type === 'whotofollow') {
             // People following me, but I don't follow them. So "Follow Back".
             actionBtn = `
                <button onclick="followUser(this, ${user.id})" class="w-full py-2.5 rounded-xl bg-primary hover:bg-primary-hover text-white font-semibold transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2 text-sm group/btn">
                    <span class="material-symbols-outlined text-[18px] group-hover/btn:scale-110 transition-transform">person_add</span>
                    Follow Back
                </button>`;
        } else if (type === 'requests') {
             actionBtn = `
                <div class="flex gap-2 w-full">
                    <button onclick="handleRequest(${user.id}, 'accept', this)" class="flex-1 py-2.5 rounded-xl bg-primary hover:bg-primary-hover text-white font-semibold transition-all shadow-lg shadow-primary/20 text-sm">Confirm</button>
                    <button onclick="handleRequest(${user.id}, 'reject', this)" class="flex-1 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white font-semibold transition-all text-sm border border-white/5">Delete</button>
                </div>
             `;
        }

        return `
            <div class="glass-card p-0 rounded-3xl flex flex-col overflow-hidden group hover:-translate-y-2 transition-transform duration-300 h-full">
                <div class="h-24 bg-gradient-to-tr from-emerald-500/20 to-teal-500/20 relative"></div>
                <div class="px-5 pb-5 flex flex-col items-center text-center -mt-12 flex-1 relative z-10">
                    <img src="${avatar}" class="w-24 h-24 rounded-full object-cover border-[5px] border-[#151925] shadow-lg mb-3 cursor-pointer" onclick="window.location.href='profile.html?id=${user.id}'">
                    <h3 class="font-bold text-white text-lg truncate w-full group-hover:text-emerald-400 transition-colors cursor-pointer" onclick="window.location.href='profile.html?id=${user.id}'">${user.name}</h3>
                    <p class="text-slate-500 text-xs font-medium mb-5">
                        ${type === 'suggestions' ? 'Suggested for you' : 
                          type === 'friends' ? 'Friend' : 
                          type === 'whotofollow' ? 'Follows you' :
                          'Wants to follow you'}
                    </p>
                    <div class="mt-auto w-full">
                        ${actionBtn}
                    </div>
                </div>
            </div>
        `;
    }

    function renderPagination(meta, type) {
        if (!meta || meta.total_pages <= 1) {
            document.getElementById('pagination-controls').innerHTML = '';
            return;
        }

        const prevDisabled = meta.current_page <= 1 ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-white/10 text-white cursor-pointer';
        const nextDisabled = meta.current_page >= meta.last_page ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-white/10 text-white cursor-pointer';

        // Determine which function to call based on type
        let fetchFn = 'fetchSuggestions';
        if (type === 'friends') fetchFn = 'fetchFriends';
        else if (type === 'requests') fetchFn = 'fetchRequests';
        else if (type === 'whotofollow') fetchFn = 'fetchWhoToFollow';

        document.getElementById('pagination-controls').innerHTML = `
            <button onclick="${fetchFn}(${meta.current_page - 1})" ${meta.current_page <= 1 ? 'disabled' : ''} class="px-4 py-2 rounded-full bg-white/5 border border-white/10 transition-all ${prevDisabled}">
                <span class="material-symbols-outlined align-middle">chevron_left</span> Prev
            </button>
            <span class="text-sm text-slate-400">Page <span class="text-white font-bold">${meta.current_page}</span> of ${meta.last_page}</span>
            <button onclick="${fetchFn}(${meta.current_page + 1})" ${meta.current_page >= meta.last_page ? 'disabled' : ''} class="px-4 py-2 rounded-full bg-white/5 border border-white/10 transition-all ${nextDisabled}">
                Next <span class="material-symbols-outlined align-middle">chevron_right</span>
            </button>
        `;
    }

    async function followUser(btn, userId) {
        btn.innerHTML = '<span class="material-symbols-outlined text-[18px] animate-spin">progress_activity</span>';
        try {
            const response = await fetch(`${API_BASE_URL}/follow`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            const data = await response.json();
            if(data.success) {
                // If in "Who to Follow" tab, remove the card as they are now followed/requested
                if (currentTab === 'whotofollow') {
                    const card = btn.closest('.glass-card');
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove(); 
                        if(document.querySelectorAll('#content-container .glass-card').length === 0) {
                            fetchWhoToFollow(pageStates.whotofollow);
                        }
                    }, 300);
                    showToast("Followed back!", 'success');
                    return;
                }

                // Check if status is pending
                const status = data.data && data.data.status ? data.data.status : 'pending';
                if(status === 'pending') {
                     btn.className = "w-full py-2.5 rounded-xl bg-yellow-500/10 text-yellow-500 font-semibold border border-yellow-500/20 flex items-center justify-center gap-2 text-sm";
                     btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">schedule</span> Requested';
                } else {
                     btn.className = "w-full py-2.5 rounded-xl bg-emerald-500/10 text-emerald-400 font-semibold border border-emerald-500/20 flex items-center justify-center gap-2 text-sm";
                     btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">check</span> Following';
                }
                btn.disabled = true;
            } else {
                 btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">person_add</span> Add Friend';
                 showToast(data.message || 'Action failed', 'error');
            }
        } catch(e) { console.error(e); }
    }
</script>

<!-- Mobile Bottom Navigation -->
<nav class="md:hidden fixed bottom-0 w-full glass-nav-mobile z-50 px-6 py-3 flex justify-between items-center pb-5 shadow-[0_-10px_40px_rgba(0,0,0,0.4)]">
    <a href="homefeed-dashboard.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition-colors group">
        <span class="material-symbols-outlined text-[28px] group-hover:scale-110 transition-transform">home</span>
    </a>
    <a href="reels.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition-colors group">
        <span class="material-symbols-outlined text-[28px] group-hover:scale-110 transition-transform">movie</span>
    </a>
    <a href="friendreq.html" class="flex flex-col items-center gap-1 text-primary group relative">
            <span class="material-symbols-outlined text-[28px] group-hover:scale-110 transition-transform filled-icon" style="font-variation-settings: 'FILL' 1;">group</span>
    </a>
    <a href="message.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition-colors group">
        <span class="material-symbols-outlined text-[28px] group-hover:scale-110 transition-transform">mail</span>
    </a>
    <a href="profile.html" class="flex flex-col items-center gap-1 text-slate-400 hover:text-white transition-colors group">
        <img id="mobile-nav-avatar" src="" class="w-7 h-7 rounded-full object-cover border border-white/10 group-hover:border-primary/50 transition-colors">
    </a>
</nav>
<script>
document.addEventListener('DOMContentLoaded', () => {
    if(window.currentUserData && window.currentUserData.name) {
        const avatar = getAvatarUrl(window.currentUserData) || window.DEFAULT_AVATAR(window.currentUserData.name);
         const navAvatar = document.getElementById('mobile-nav-avatar');
         if(navAvatar) navAvatar.src = avatar;
    }
});
</script>
</body></html>